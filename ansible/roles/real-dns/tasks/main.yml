---
- name: Install bind
  dnf:
    name:
      - bind
    state: present
- name: Configure named.mit.zones
  template:
    src: named.mit.zones.j2
    dest: /etc/named.mit.zones
  notify: reload named
- name: Configure named.conf
  blockinfile:
    path: /etc/named.conf
    block: |
      include "/etc/named.mit.zones";
  notify: reload named
- name: Configure named listen port
  vars:
    port: "{% if use_shackle %}54{% else %}53{% endif %}"
  lineinfile:
    path: /etc/named.conf
    insertafter: '^\s*options'
    regexp: '^\s*{{ item.split()[0] }}\s'
    line: "{{ item }}"
  notify: reload named
  loop:
    - "listen-on port {{ port }} { 127.0.0.1; };"
    - "listen-on-v6 port {{ port }} { ::1; };"
- name: Ensure named is listening on the correct port before continuing
  meta: flush_handlers
- name: Shackle
  when: use_shackle
  block:
  - name: Install shackle
    dnf: name=shackle state=present
  - name: Start shackle
    systemd:
      name: shackle.socket
      state: started
      enabled: yes
- name: Start named
  service:
    name: named
    state: started
    enabled: yes
- name: Configure DNS servers
  ini_file:
    no_extra_spaces: yes
    path: /etc/sysconfig/network-scripts/ifcfg-{{ ansible_default_ipv4.interface }}
    section: null
    option: "{{ item.key }}"
    value: '"{{ item.value }}"'
  with_dict:
    DOMAIN: mit.edu
    DNS1: 127.0.0.1
    PEERDNS: "no"
  notify: restart NetworkManager
